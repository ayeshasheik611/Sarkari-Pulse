<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk MyScheme Scraping Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            border-left: 5px solid #007bff;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .progress-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log-section {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-timestamp {
            color: #a0aec0;
            font-size: 0.9em;
        }

        .log-message {
            margin-left: 10px;
        }

        .schemes-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table-header {
            background: #343a40;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .table-content {
            max-height: 500px;
            overflow-y: auto;
        }

        .scheme-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .scheme-item:hover {
            background-color: #f8f9fa;
        }

        .scheme-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .scheme-details {
            color: #666;
            font-size: 0.9em;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-idle { background-color: #6c757d; }
        .status-running { background-color: #ffc107; animation: pulse 2s infinite; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Bulk MyScheme Scraping Dashboard</h1>
            <p>Extract all 3,850+ government schemes from MyScheme.gov.in</p>
        </div>

        <div class="dashboard">
            <!-- Status Alert -->
            <div id="statusAlert" class="alert alert-info">
                <span class="status-indicator status-idle"></span>
                <strong>Ready to start bulk scraping</strong> - Click "Start Bulk Scraping" to extract all schemes
            </div>

            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Schemes</h3>
                    <div class="stat-value" id="totalSchemes">0</div>
                    <div class="stat-label">In Database</div>
                </div>
                <div class="stat-card">
                    <h3>Target Progress</h3>
                    <div class="stat-value" id="progressPercent">0%</div>
                    <div class="stat-label">of 3,850 schemes</div>
                </div>
                <div class="stat-card">
                    <h3>Scraping Status</h3>
                    <div class="stat-value" id="scrapingStatus">Idle</div>
                    <div class="stat-label">Current State</div>
                </div>
                <div class="stat-card">
                    <h3>Last Updated</h3>
                    <div class="stat-value" id="lastUpdated">Never</div>
                    <div class="stat-label">Latest Scrape</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-section">
                <h3>Extraction Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
                <p id="progressText">Ready to start bulk extraction</p>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-success" id="startBulkBtn" onclick="startBulkScraping()">
                    üöÄ Start Bulk Scraping
                </button>
                <button class="btn btn-primary" id="refreshBtn" onclick="refreshStats()">
                    üîÑ Refresh Stats
                </button>
                <button class="btn btn-warning" onclick="viewAllSchemes()">
                    üìã View All Schemes
                </button>
                <button class="btn btn-primary" onclick="exportSchemes()">
                    üíæ Export Data
                </button>
            </div>

            <!-- Live Log -->
            <div class="log-section">
                <h3 style="margin-bottom: 15px;">üìä Live Scraping Log</h3>
                <div id="liveLog">
                    <div class="log-entry">
                        <span class="log-timestamp">[Ready]</span>
                        <span class="log-message">Dashboard initialized - ready to start bulk scraping</span>
                    </div>
                </div>
            </div>

            <!-- Recent Schemes -->
            <div class="schemes-table">
                <div class="table-header">
                    üìã Recently Extracted Schemes
                </div>
                <div class="table-content" id="recentSchemes">
                    <div class="scheme-item">
                        <div class="scheme-name">No schemes extracted yet</div>
                        <div class="scheme-details">Start bulk scraping to see extracted schemes here</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let isScrapingActive = false;

        // Initialize WebSocket connection
        function initWebSocket() {
            try {
                socket = new WebSocket('ws://localhost:9000');
                
                socket.onopen = function() {
                    addLogEntry('WebSocket connected - real-time updates enabled');
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                socket.onclose = function() {
                    addLogEntry('WebSocket disconnected - trying to reconnect...');
                    setTimeout(initWebSocket, 5000);
                };
                
                socket.onerror = function(error) {
                    addLogEntry('WebSocket error: ' + error.message);
                };
            } catch (error) {
                addLogEntry('Failed to connect WebSocket: ' + error.message);
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            const { type, payload } = data;
            
            switch(type) {
                case 'bulk-scrape-started':
                    updateScrapingStatus('Running', 'status-running');
                    updateStatusAlert('info', 'Bulk scraping started - extracting all schemes...');
                    addLogEntry('üöÄ Bulk scraping started');
                    break;
                    
                case 'bulk-scrape-progress':
                    const progress = payload.progress || 0;
                    updateProgress(progress, payload.message);
                    addLogEntry(`üìä ${payload.message}`);
                    break;
                    
                case 'bulk-scrape-completed':
                    updateScrapingStatus('Completed', 'status-success');
                    updateStatusAlert('success', `Bulk scraping completed! ${payload.result?.scraped || 0} schemes extracted`);
                    addLogEntry(`‚úÖ Bulk scraping completed: ${payload.result?.scraped || 0} schemes`);
                    isScrapingActive = false;
                    document.getElementById('startBulkBtn').disabled = false;
                    refreshStats();
                    break;
                    
                case 'bulk-scrape-error':
                    updateScrapingStatus('Error', 'status-error');
                    updateStatusAlert('danger', 'Bulk scraping failed: ' + payload.error);
                    addLogEntry(`‚ùå Bulk scraping failed: ${payload.error}`);
                    isScrapingActive = false;
                    document.getElementById('startBulkBtn').disabled = false;
                    break;
                    
                case 'bulk-save-progress':
                    addLogEntry(`üíæ Database save progress: ${payload.saved} saved, ${payload.updated} updated`);
                    break;
            }
        }

        // Start bulk scraping
        async function startBulkScraping() {
            if (isScrapingActive) {
                alert('Bulk scraping is already in progress!');
                return;
            }

            const confirmed = confirm(
                'This will start bulk scraping to extract ALL 3,850+ schemes from MyScheme.gov.in.\n\n' +
                'This process will take 15-30 minutes and will make hundreds of API requests.\n\n' +
                'Are you sure you want to continue?'
            );

            if (!confirmed) return;

            try {
                isScrapingActive = true;
                document.getElementById('startBulkBtn').disabled = true;
                updateScrapingStatus('Starting...', 'status-running');
                updateStatusAlert('info', 'Initializing bulk scraping...');
                addLogEntry('üöÄ Starting bulk scraping process...');

                const response = await fetch('/api/myscheme/bulk-scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        maxPages: 200,
                        pageSize: 50,
                        delayBetweenRequests: 800,
                        saveToDb: true,
                        notifyProgress: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    updateStatusAlert('info', result.message);
                    addLogEntry(`‚úÖ ${result.message}`);
                    addLogEntry(`‚è±Ô∏è Estimated time: ${result.estimatedTime}`);
                    addLogEntry(`üéØ Target: ${result.targetSchemes} schemes`);
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                isScrapingActive = false;
                document.getElementById('startBulkBtn').disabled = false;
                updateScrapingStatus('Error', 'status-error');
                updateStatusAlert('danger', 'Failed to start bulk scraping: ' + error.message);
                addLogEntry(`‚ùå Failed to start: ${error.message}`);
            }
        }

        // Refresh statistics
        async function refreshStats() {
            try {
                addLogEntry('üîÑ Refreshing statistics...');
                
                const response = await fetch('/api/myscheme/bulk-status');
                const result = await response.json();

                if (result.success) {
                    const stats = result.status;
                    
                    // Update statistics
                    document.getElementById('totalSchemes').textContent = stats.totalSchemes.toLocaleString();
                    
                    const progressPercent = Math.round((stats.totalSchemes / 3850) * 100);
                    document.getElementById('progressPercent').textContent = progressPercent + '%';
                    
                    // Update progress bar
                    updateProgress(progressPercent, `${stats.totalSchemes} of 3,850 schemes extracted`);
                    
                    // Update last updated
                    if (stats.recentSchemes.length > 0) {
                        const lastUpdated = new Date(stats.recentSchemes[0].scrapedAt);
                        document.getElementById('lastUpdated').textContent = lastUpdated.toLocaleTimeString();
                    }
                    
                    // Update recent schemes
                    updateRecentSchemes(stats.recentSchemes);
                    
                    addLogEntry(`‚úÖ Stats updated: ${stats.totalSchemes} total schemes`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                addLogEntry(`‚ùå Failed to refresh stats: ${error.message}`);
            }
        }

        // Update progress bar
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            progressText.textContent = message;
        }

        // Update scraping status
        function updateScrapingStatus(status, statusClass) {
            const statusElement = document.getElementById('scrapingStatus');
            statusElement.textContent = status;
            
            // Update status indicator
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator ' + statusClass;
            });
        }

        // Update status alert
        function updateStatusAlert(type, message) {
            const alert = document.getElementById('statusAlert');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span class="status-indicator status-${type === 'info' ? 'running' : type}"></span><strong>${message}</strong>`;
        }

        // Add log entry
        function addLogEntry(message) {
            const logContainer = document.getElementById('liveLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Update recent schemes display
        function updateRecentSchemes(schemes) {
            const container = document.getElementById('recentSchemes');
            
            if (schemes.length === 0) {
                container.innerHTML = `
                    <div class="scheme-item">
                        <div class="scheme-name">No schemes found</div>
                        <div class="scheme-details">Start scraping to see extracted schemes</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = schemes.map(scheme => `
                <div class="scheme-item">
                    <div class="scheme-name">${scheme.name}</div>
                    <div class="scheme-details">
                        Ministry: ${scheme.ministry || 'N/A'} | 
                        Source: ${scheme.source} | 
                        Scraped: ${new Date(scheme.scrapedAt).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        // View all schemes
        function viewAllSchemes() {
            window.open('/api/myscheme?limit=100', '_blank');
        }

        // Export schemes data
        async function exportSchemes() {
            try {
                addLogEntry('üì• Preparing data export...');
                
                const response = await fetch('/api/myscheme?limit=5000');
                const result = await response.json();
                
                if (result.success) {
                    const dataStr = JSON.stringify(result.data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `myscheme_schemes_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    addLogEntry(`‚úÖ Exported ${result.data.length} schemes to JSON file`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                addLogEntry(`‚ùå Export failed: ${error.message}`);
            }
        }

        // Initialize dashboard
        function initDashboard() {
            addLogEntry('üéõÔ∏è Initializing dashboard...');
            initWebSocket();
            refreshStats();
            
            // Auto-refresh stats every 30 seconds
            setInterval(refreshStats, 30000);
            
            addLogEntry('‚úÖ Dashboard ready');
        }

        // Start dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>